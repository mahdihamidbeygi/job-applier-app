{% extends 'core/base.html' %} {% load static %} {% block content %}
<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h2 class="text-center">Manual Job Application Submission</h2>
        </div>
        <div class="card-body">
          <form id="manualSubmissionForm">
            <div class="form-group mb-4">
              <label for="jobDescription" class="form-label"
                >Job Description</label
              >
              <textarea
                class="form-control"
                id="jobDescription"
                rows="10"
                placeholder="Paste the job description here..."
              ></textarea>
            </div>
            <div class="d-grid gap-2">
              <button
                type="button"
                class="btn btn-primary"
                id="generateResumeBtn"
                onclick="generateDocuments('resume', this)"
              >
                Generate Tailored Resume
              </button>
              <button
                type="button"
                class="btn btn-primary"
                id="generateCoverLetterBtn"
                onclick="generateDocuments('cover_letter', this)"
              >
                Generate Cover Letter
              </button>
            </div>
            <!-- Application Questions Section -->
            <div class="form-group mb-4 mt-4">
              <label for="applicationQuestions" class="form-label"
                >Application Questions</label
              >
              <textarea
                class="form-control"
                id="applicationQuestions"
                rows="5"
                placeholder="Enter your application questions here..."
              ></textarea>
              <button
                type="button"
                class="btn btn-primary mt-2"
                id="generateAnswersBtn"
                onclick="generateAnswers(this)"
              >
                Generate Answers
              </button>
            </div>
            <!-- Answers Section -->
            <div id="answersSection" class="mt-4 d-none">
              <h4>Generated Answers</h4>
              <div id="answersContent" class="border p-3 rounded"></div>
            </div>
            <!-- Loading spinner -->
            <div id="loadingSpinner" class="text-center mt-3 d-none">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Generating your document...</p>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  async function generateDocuments(type, button) {
    const jobDescription = document.getElementById("jobDescription").value;
    const loadingSpinner = document.getElementById("loadingSpinner");

    if (!jobDescription) {
      alert("Please fill in the job description.");
      return;
    }

    // Disable the button and show loading spinner
    button.disabled = true;
    loadingSpinner.classList.remove("d-none");

    try {
      const response = await fetch("/process-application/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({
          job_description: jobDescription,
          document_type: type,
          additional_services: {
            answer_questions: false,
            prepare_interview: false,
          },
        }),
      });

      if (response.ok) {
        const data = await response.json();

        // Convert base64 to blob
        const base64Data = data.documents[type];
        const byteCharacters = atob(base64Data);
        const byteArrays = [];

        for (let offset = 0; offset < byteCharacters.length; offset += 1024) {
          const slice = byteCharacters.slice(offset, offset + 1024);
          const byteNumbers = new Array(slice.length);

          for (let i = 0; i < slice.length; i++) {
            byteNumbers[i] = slice.charCodeAt(i);
          }

          const byteArray = new Uint8Array(byteNumbers);
          byteArrays.push(byteArray);
        }

        const blob = new Blob(byteArrays, { type: "application/pdf" });
        const fileName = `${type === "resume" ? "resume" : "cover_letter"}_${
          new Date().toISOString().split("T")[0]
        }.pdf`;
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
      } else {
        const errorData = await response.json();
        throw new Error(errorData.error || "Failed to generate document");
      }
    } catch (error) {
      alert("Error generating document: " + error.message);
      console.error("Error:", error);
    } finally {
      // Re-enable the button and hide loading spinner
      button.disabled = false;
      loadingSpinner.classList.add("d-none");
    }
  }

  async function generateAnswers(button) {
    const jobDescription = document.getElementById("jobDescription").value;
    const questions = document.getElementById("applicationQuestions").value;
    const loadingSpinner = document.getElementById("loadingSpinner");
    const answersSection = document.getElementById("answersSection");
    const answersContent = document.getElementById("answersContent");

    if (!jobDescription) {
      alert("Please fill in the job description.");
      return;
    }

    if (!questions) {
      alert("Please enter your application questions.");
      return;
    }

    // Disable the button and show loading spinner
    button.disabled = true;
    loadingSpinner.classList.remove("d-none");
    loadingSpinner.querySelector("p").textContent = "Generating answers...";

    try {
      const response = await fetch("/process-application/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({
          job_description: jobDescription,
          questions: questions.split("\n").filter((q) => q.trim()),
          document_type: "none",
          additional_services: {
            answer_questions: true,
            prepare_interview: false,
          },
        }),
      });
      console.log(response);
      if (response.ok) {
        const data = await response.json();

        // Display the answers
        if (Array.isArray(data.answers)) {
          answersContent.innerHTML = data.answers
            .map(
              (answer) =>
                `<div class="mb-3">
              <strong>Q: ${answer.question}</strong><br>
              A: ${answer.answer}
            </div>`
            )
            .join("");
        } else {
          answersContent.innerHTML = data.answers.replace(/\n/g, "<br>");
        }
        answersSection.classList.remove("d-none");
      } else {
        const errorData = await response.json();
        throw new Error(errorData.error || "Failed to generate answers");
      }
    } catch (error) {
      alert("Error generating answers: " + error.message);
      console.error("Error:", error);
    } finally {
      // Re-enable the button and hide loading spinner
      button.disabled = false;
      loadingSpinner.classList.add("d-none");
      loadingSpinner.querySelector("p").textContent =
        "Generating your document...";
    }
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>
{% endblock %}
