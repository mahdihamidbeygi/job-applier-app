{% extends 'core/base.html' %} {% load static %} {% block title %}Jobs - Job
Applier{% endblock %} {% block content %}
<!-- Add CSRF Token -->
{% csrf_token %}

<div class="container-fluid px-4 py-5">
  <!-- Hero Section -->
  <div class="text-center mb-5">
    <h1 class="display-4 fw-bold text-primary mb-3">Find Your Dream Job</h1>
    <p class="lead text-muted">
      Let AI help you discover and apply to the perfect opportunities
    </p>
  </div>

  <!-- Search Section with Modern Design -->
  <div class="row justify-content-center mb-5">
    <div class="col-lg-8">
      <div class="card bg-gradient shadow-lg border-0">
        <div class="card-body p-4">
          <form id="searchForm" class="row g-3">
            <div class="col-md-5">
              <div class="form-floating">
                <input
                  type="text"
                  class="form-control bg-dark text-light border-0"
                  id="role"
                  name="role"
                  placeholder="Job Role"
                  value="{{ role }}"
                />
                <label for="role" class="text-muted"
                  >Job Role (e.g. Software Engineer)</label
                >
              </div>
            </div>
            <div class="col-md-5">
              <div class="form-floating">
                <input
                  type="text"
                  class="form-control bg-dark text-light border-0"
                  id="location"
                  name="location"
                  placeholder="Location"
                  value="{{ location }}"
                />
                <label for="location" class="text-muted"
                  >Location (e.g. New York)</label
                >
              </div>
            </div>
            <div class="col-md-2">
              <button type="submit" class="btn btn-primary h-100 w-100">
                Search
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Animation -->
  <div id="loadingIndicator" class="text-center py-5 d-none">
    <div class="spinner-grow text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3 text-muted">Searching for the best opportunities...</p>
  </div>

  <!-- Job Listings with Modern Cards -->
  <div id="jobListings" class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4">
    {% for job in job_listings %}
    <div class="col">
      <div class="card h-100 border-0 shadow-sm hover-lift">
        <div class="card-body p-4">
          <!-- Job Header -->
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <h3 class="h5 mb-1">{{ job.title }}</h3>
              <p class="text-primary mb-0">{{ job.company }}</p>
              <div class="d-flex align-items-center text-muted">
                <i class="fas fa-map-marker-alt me-2"></i>
                <small>{{ job.location }}</small>
              </div>
            </div>
            <div class="ms-3">
              <div
                class="badge {% if job.match_score >= 70 %}bg-success{% elif job.match_score >= 50 %}bg-warning{% else %}bg-danger{% endif %} rounded-pill"
              >
                {{ job.match_score }}% Match
              </div>
              {% if job.applied %}
              <div class="badge bg-primary rounded-pill mt-2">Applied</div>
              {% endif %}
            </div>
          </div>

          <!-- Job Description -->
          <p class="text-muted mb-4 job-description">
            {{ job.description|truncatewords:50 }}
          </p>

          <!-- Job Details -->
          <div class="d-flex flex-wrap gap-2 mb-4">
            {% if job.job_type %}
            <span class="badge bg-dark">{{ job.job_type }}</span>
            {% endif %} {% if job.experience_level %}
            <span class="badge bg-dark">{{ job.experience_level }}</span>
            {% endif %} {% if job.salary_range %}
            <span class="badge bg-dark">{{ job.salary_range }}</span>
            {% endif %}
          </div>

          <!-- Action Buttons -->
          <div class="card-footer bg-transparent border-0 p-0">
            <div class="d-flex flex-wrap gap-2">
              {% if job.tailored_resume %}
              <a
                href="{{ job.tailored_resume.url }}"
                class="btn btn-outline-primary btn-sm"
                target="_blank"
              >
                <i class="fas fa-file-alt me-2"></i>View Resume
              </a>
              {% endif %} {% if job.tailored_cover_letter %}
              <a
                href="{{ job.tailored_cover_letter.url }}"
                class="btn btn-outline-primary btn-sm"
                target="_blank"
              >
                <i class="fas fa-envelope me-2"></i>View Cover Letter
              </a>
              {% endif %}
              <a
                href="{{ job.source_url }}"
                class="btn btn-outline-secondary btn-sm"
                target="_blank"
              >
                <i class="fab fa-linkedin me-2"></i>View on LinkedIn
              </a>
              {% if not job.applied %}
              <button
                onclick="applyToJob({{ job.id }})"
                class="btn btn-success btn-sm ms-auto"
              >
                <i class="fas fa-paper-plane me-2"></i>Apply Now
              </button>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
    {% empty %}
    <div class="col-12 text-center py-5">
      <div class="empty-state">
        <i class="fas fa-search fa-3x text-muted mb-4"></i>
        <h3 class="h4 text-muted">No jobs found</h3>
        <p class="text-muted">
          Try adjusting your search criteria or explore different roles
        </p>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<!-- Custom Styles -->
<style>
  .hover-lift {
    transition: transform 0.2s ease-in-out;
  }
  .hover-lift:hover {
    transform: translateY(-5px);
  }
  .job-description {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .empty-state {
    padding: 3rem;
    background: var(--card-bg);
    border-radius: 1rem;
  }
  .bg-gradient {
    background: linear-gradient(45deg, var(--card-bg), var(--darker-bg));
  }
</style>

<!-- Custom Scripts -->
<script>
  document
    .getElementById("searchForm")
    .addEventListener("submit", async function (e) {
      e.preventDefault();

      const loadingIndicator = document.getElementById("loadingIndicator");
      const jobListings = document.getElementById("jobListings");

      // Show loading animation
      loadingIndicator.classList.remove("d-none");
      jobListings.style.opacity = "0.5";

      const role = document.getElementById("role").value;
      const location = document.getElementById("location").value;

      try {
        const response = await fetch("{% url 'core:search_jobs' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]")
              .value,
          },
          body: JSON.stringify({
            role: role,
            location: location,
          }),
        });

        const data = await response.json();

        if (response.ok) {
          // Update URL with search parameters
          const url = new URL(window.location.href);
          url.searchParams.set("role", role);
          url.searchParams.set("location", location);
          window.history.pushState({}, "", url);

          // Reload page to show results
          window.location.reload();
        } else {
          showAlert("error", data.error || "Failed to search jobs");
          console.error("Search failed:", data);
        }
      } catch (error) {
        showAlert("error", "An error occurred while searching for jobs");
        console.error("Search error:", error);
      } finally {
        // Hide loading animation
        loadingIndicator.classList.add("d-none");
        jobListings.style.opacity = "1";
      }
    });

  async function applyToJob(jobId) {
    try {
      const response = await fetch(
        `{% url 'core:apply_to_job' 0 %}`.replace("0", jobId),
        {
          method: "POST",
          headers: {
            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]")
              .value,
          },
        }
      );

      const data = await response.json();

      if (response.ok) {
        showAlert("success", "Successfully applied to job!");
        setTimeout(() => window.location.reload(), 1500);
      } else {
        showAlert("error", data.error || "Failed to apply to job");
        console.error("Apply failed:", data);
      }
    } catch (error) {
      showAlert("error", "An error occurred while applying to the job");
      console.error("Apply error:", error);
    }
  }

  function showAlert(type, message) {
    const alertDiv = document.createElement("div");
    alertDiv.className = `alert alert-${
      type === "error" ? "danger" : "success"
    } alert-dismissible fade show position-fixed top-0 end-0 m-3`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    setTimeout(() => alertDiv.remove(), 5000);
  }
</script>
{% endblock %}
