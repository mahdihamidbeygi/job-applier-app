{% extends 'core/base.html' %} {% load static %} {% block title %}Jobs - Job
Applier{% endblock %} {% block content %}
<!-- Add CSRF Token -->
{% csrf_token %}

<div class="container mt-4">
  <!-- Search Form -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Search Jobs</h5>
      <form id="jobSearchForm" class="row g-3">
        <div class="col-md-5">
          <label for="role" class="form-label">Job Title</label>
          <input
            type="text"
            class="form-control"
            id="role"
            name="role"
            value="{{ role }}"
            placeholder="e.g., Software Engineer"
          />
        </div>
        <div class="col-md-5">
          <label for="location" class="form-label">Location</label>
          <input
            type="text"
            class="form-control"
            id="location"
            name="location"
            value="{{ location }}"
            placeholder="e.g., New York, NY"
          />
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100">Search</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Job Listings -->
  <div id="jobListings">
    {% if job_listings %} {% for job in job_listings %}
    <div class="card mb-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <h5 class="card-title">{{ job.title }}</h5>
            <h6 class="card-subtitle mb-2 text-muted">{{ job.company }}</h6>
            <p class="card-text">
              <i class="fas fa-map-marker-alt"></i> {{ job.location }}
            </p>
            <div class="match-score">
              <span
                class="badge bg-{% if job.match_score >= 80 %}success{% elif job.match_score >= 60 %}warning{% else %}danger{% endif %}"
              >
                Match Score: {{ job.match_score }}%
              </span>
            </div>
          </div>
          <div class="text-end">
            <a
              href="{% url 'core:job_detail' job.id %}"
              class="btn btn-outline-primary"
              >View Details</a
            >
            {% if job.applied %}
            <span class="badge bg-success ms-2">Applied</span>
            {% endif %}
          </div>
        </div>

        <!-- Job Preview -->
        <div class="mt-3">
          <p class="card-text">{{ job.description|truncatewords:50 }}</p>
          <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted">
              Posted: {{ job.posted_date|date:"M d, Y" }}
            </small>
            <a
              href="{{ job.source_url }}"
              target="_blank"
              class="btn btn-sm btn-outline-secondary"
              ><i class="fab fa-linkedin"></i> View on LinkedIn</a
            >
          </div>
        </div>
      </div>
    </div>
    {% endfor %} {% else %}
    <div class="alert alert-info">
      No jobs found. Try adjusting your search criteria.
    </div>
    {% endif %}
  </div>
</div>

<!-- Loading Spinner -->
<div
  id="loadingSpinner"
  class="position-fixed top-50 start-50 translate-middle d-none"
>
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>

<!-- Custom Styles -->
<style>
  .hover-lift {
    transition: transform 0.2s ease-in-out;
  }
  .hover-lift:hover {
    transform: translateY(-5px);
  }
  .job-description {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .empty-state {
    padding: 3rem;
    background: var(--card-bg);
    border-radius: 1rem;
  }
  .bg-gradient {
    background: linear-gradient(45deg, var(--card-bg), var(--darker-bg));
  }
</style>

<!-- Custom Scripts -->
<script>
  // Function to get the authentication token
  function getAuthToken() {
    return localStorage.getItem("authToken");
  }

  document
    .getElementById("jobSearchForm")
    .addEventListener("submit", function (e) {
      e.preventDefault();

      const role = document.getElementById("role").value;
      const location = document.getElementById("location").value;
      const authToken = getAuthToken();

      if (!authToken) {
        alert("Please log in to search for jobs.");
        window.location.href = "{% url 'core:login' %}";
        return;
      }

      // Show loading spinner
      document.getElementById("loadingSpinner").classList.remove("d-none");

      // Make API call
      fetch("/api/search-jobs/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
          Authorization: `Bearer ${authToken}`,
        },
        credentials: "include",
        body: JSON.stringify({
          role: role,
          location: location,
        }),
      })
        .then((response) => {
          if (response.status === 401) {
            // Token expired or invalid
            localStorage.removeItem("authToken");
            window.location.href = "{% url 'core:login' %}";
            return Promise.reject("Authentication required");
          }
          return response.json();
        })
        .then((data) => {
          // Hide loading spinner
          document.getElementById("loadingSpinner").classList.add("d-none");

          if (data.jobs && data.jobs.length > 0) {
            // Update URL with search parameters
            const url = new URL(window.location.href);
            url.searchParams.set("role", role);
            url.searchParams.set("location", location);
            window.history.pushState({}, "", url);

            // Reload page to show results
            window.location.reload();
          } else {
            // Show no results message
            document.getElementById("jobListings").innerHTML = `
            <div class="alert alert-info">
              No jobs found. Try adjusting your search criteria.
            </div>
          `;
          }
        })
        .catch((error) => {
          // Hide loading spinner
          document.getElementById("loadingSpinner").classList.add("d-none");

          console.error("Error:", error);
          if (error !== "Authentication required") {
            alert("An error occurred while searching for jobs.");
          }
        });
    });

  // Helper function to get CSRF token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>
{% endblock %}
