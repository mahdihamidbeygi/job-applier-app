{% extends 'core/base.html' %} {% load static %} {% block title %}Jobs - Job
Applier{% endblock %} {% block content %}
<!-- Add CSRF Token -->
{% csrf_token %}

<div class="container mt-4">
  <!-- Search Form -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Search Jobs</h5>
      <form id="jobSearchForm" class="row g-3">
        <div class="col-md-4">
          <label for="role" class="form-label">Job Title</label>
          <input
            type="text"
            class="form-control"
            id="role"
            name="role"
            value="{{ role }}"
            placeholder="e.g., Software Engineer"
          />
        </div>
        <div class="col-md-3">
          <label for="location" class="form-label">Location</label>
          <input
            type="text"
            class="form-control"
            id="location"
            name="location"
            value="{{ location }}"
            placeholder="e.g., New York, NY"
          />
        </div>
        <div class="col-md-3">
          <label for="platforms" class="form-label">Platforms</label>
          <select class="form-select" id="platforms" name="platforms" multiple>
            <option value="linkedin">LinkedIn</option>
            <option value="indeed">Indeed</option>
            <option value="glassdoor">Glassdoor</option>
            <option value="monster">Monster</option>
            <option value="jobbank">JobBank</option>
            <option value="ziprecruiter">ZipRecruiter</option>
          </select>
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100">Search</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Job Listings -->
  <div id="jobListings">
    {% if job_listings %} {% for job in job_listings %}
    <div class="card mb-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <h5 class="card-title">{{ job.title }}</h5>
            <h6 class="card-subtitle mb-2 text-muted">{{ job.company }}</h6>
            <p class="card-text">
              <i class="fas fa-map-marker-alt"></i> {{ job.location }}
            </p>
            <div class="match-score">
              <span
                class="badge bg-{% if job.match_score >= 80 %}success{% elif job.match_score >= 60 %}warning{% else %}danger{% endif %}"
              >
                Match Score: {{ job.match_score }}%
              </span>
            </div>
          </div>
          <div class="text-end">
            <a
              href="{% url 'core:job_detail' job.id %}"
              class="btn btn-outline-primary"
              >View Details</a
            >
            {% if job.applied %}
            <span class="badge bg-success ms-2">Applied</span>
            {% endif %} {% if job.has_tailored_documents %}
            <span
              class="badge bg-info ms-2"
              title="Resume and cover letter are ready"
            >
              <i class="fas fa-file-alt"></i> Documents Ready
            </span>
            {% endif %}
            <button
              class="btn btn-outline-danger ms-2 remove-job"
              data-job-id="{{ job.id }}"
              title="Remove from results"
            >
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>

        <!-- Job Preview -->
        <div class="mt-3">
          <p class="card-text">{{ job.description|truncatewords:50 }}</p>
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <small class="text-muted">
                Posted: {{ job.posted_date|date:"M d, Y" }}
              </small>
              <span class="badge bg-secondary ms-2"
                >{{ job.source|title }}</span
              >
            </div>
            <a
              href="{{ job.source_url }}"
              target="_blank"
              class="btn btn-sm btn-outline-secondary"
            >
              <i class="fab fa-{{ job.source|lower }}"></i> View on
              <!---->
              {{ job.source|title }}
            </a>
          </div>
        </div>
      </div>
    </div>
    {% endfor %} {% else %}
    <div class="alert alert-info">
      No jobs found. Try adjusting your search criteria.
    </div>
    {% endif %}
  </div>
</div>

<!-- Loading Spinner -->
<div
  id="loadingSpinner"
  class="position-fixed top-50 start-50 translate-middle d-none"
>
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>

<!-- Custom Styles -->
<style>
  .hover-lift {
    transition: transform 0.2s ease-in-out;
  }
  .hover-lift:hover {
    transform: translateY(-5px);
  }
  .job-description {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .empty-state {
    padding: 3rem;
    background: var(--card-bg);
    border-radius: 1rem;
  }
  .bg-gradient {
    background: linear-gradient(45deg, var(--card-bg), var(--darker-bg));
  }
</style>

<!-- Custom Scripts -->
<script>
  // Function to get the authentication token
  function getAuthToken() {
    return localStorage.getItem("authToken");
  }

  // Function to remove a job from results
  function removeJob(jobId) {
    const authToken = getAuthToken();
    if (!authToken) {
      alert("Please log in to remove jobs.");
      window.location.href = "{% url 'core:login' %}";
      return;
    }

    fetch("/api/jobs/remove/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken"),
        Authorization: `Bearer ${authToken}`,
      },
      credentials: "include",
      body: JSON.stringify({
        job_id: jobId,
      }),
    })
      .then((response) => {
        if (response.status === 401) {
          localStorage.removeItem("authToken");
          window.location.href = "{% url 'core:login' %}";
          return Promise.reject("Authentication required");
        }
        return response.json();
      })
      .then((data) => {
        // Find and remove the job card from the DOM
        const jobCard = document
          .querySelector(`[data-job-id="${jobId}"]`)
          .closest(".card");
        jobCard.remove();

        // If no jobs left, show empty state
        const jobListings = document.getElementById("jobListings");
        if (jobListings.children.length === 0) {
          jobListings.innerHTML = `
            <div class="alert alert-info">
              No jobs found. Try adjusting your search criteria.
            </div>
          `;
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        if (error !== "Authentication required") {
          alert("An error occurred while removing the job.");
        }
      });
  }

  // Add click event listeners to all remove buttons
  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".remove-job").forEach((button) => {
      button.addEventListener("click", function () {
        const jobId = this.getAttribute("data-job-id");
        removeJob(jobId);
      });
    });
  });

  document
    .getElementById("jobSearchForm")
    .addEventListener("submit", function (e) {
      e.preventDefault();

      const role = document.getElementById("role").value;
      const location = document.getElementById("location").value;
      const platformsSelect = document.getElementById("platforms");
      const selectedPlatforms = Array.from(platformsSelect.selectedOptions).map(
        (option) => option.value
      );
      const authToken = getAuthToken();

      if (!authToken) {
        alert("Please log in to search for jobs.");
        window.location.href = "{% url 'core:login' %}";
        return;
      }

      // Show loading spinner
      document.getElementById("loadingSpinner").classList.remove("d-none");

      // Make API call
      fetch("/api/search-jobs/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
          Authorization: `Bearer ${authToken}`,
        },
        credentials: "include",
        body: JSON.stringify({
          role: role,
          location: location,
          platforms:
            selectedPlatforms.length > 0 ? selectedPlatforms : ["linkedin"], // Default to LinkedIn if none selected
        }),
      })
        .then((response) => {
          if (response.status === 401) {
            // Token expired or invalid
            localStorage.removeItem("authToken");
            window.location.href = "{% url 'core:login' %}";
            return Promise.reject("Authentication required");
          }
          return response.json();
        })
        .then((data) => {
          // Hide loading spinner
          document.getElementById("loadingSpinner").classList.add("d-none");

          if (data.jobs && data.jobs.length > 0) {
            // Update URL with search parameters
            const url = new URL(window.location.href);
            url.searchParams.set("role", role);
            url.searchParams.set("location", location);
            window.history.pushState({}, "", url);

            // Reload page to show results
            window.location.reload();
          } else {
            // Show no results message
            document.getElementById("jobListings").innerHTML = `
            <div class="alert alert-info">
              No jobs found. Try adjusting your search criteria.
            </div>
          `;
          }
        })
        .catch((error) => {
          // Hide loading spinner
          document.getElementById("loadingSpinner").classList.add("d-none");

          console.error("Error:", error);
          if (error !== "Authentication required") {
            alert("An error occurred while searching for jobs.");
          }
        });
    });

  // Helper function to get CSRF token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>
{% endblock %}
