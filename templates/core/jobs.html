{% extends 'core/base.html' %} {% load static %} {% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-md-4">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Job Search</h5>
          <form id="jobSearchForm">
            <div class="mb-3">
              <label for="role" class="form-label">Job Title</label>
              <input
                type="text"
                class="form-control"
                id="role"
                name="role"
                value="{{ role }}"
                required
              />
            </div>
            <div class="mb-3">
              <label for="location" class="form-label">Location</label>
              <input
                type="text"
                class="form-control"
                id="location"
                name="location"
                value="{{ location }}"
                required
              />
            </div>
            <div class="mb-3">
              <label class="form-label">Job Platforms</label>
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  name="platform"
                  value="linkedin"
                  id="linkedin"
                  checked
                />
                <label class="form-check-label" for="linkedin">LinkedIn</label>
              </div>
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  name="platform"
                  value="indeed"
                  id="indeed"
                  checked
                />
                <label class="form-check-label" for="indeed">Indeed</label>
              </div>
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  name="platform"
                  value="glassdoor"
                  id="glassdoor"
                  checked
                />
                <label class="form-check-label" for="glassdoor"
                  >Glassdoor</label
                >
              </div>
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  name="platform"
                  value="monster"
                  id="monster"
                  checked
                />
                <label class="form-check-label" for="monster">Monster</label>
              </div>
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  name="platform"
                  value="jobbank"
                  id="jobbank"
                  checked
                />
                <label class="form-check-label" for="jobbank">JobBank</label>
              </div>
            </div>
            <button type="submit" class="btn btn-primary">Search Jobs</button>
          </form>
        </div>
      </div>
    </div>
    <div class="col-md-8">
      <div id="searchResults">
        {% if job_listings %} {% for job in job_listings %}
        <div class="card mb-3">
          <div class="card-body">
            <h5 class="card-title">{{ job.title }}</h5>
            <h6 class="card-subtitle mb-2 text-muted">{{ job.company }}</h6>
            <p class="card-text">
              <small class="text-muted">
                <i class="fas fa-map-marker-alt"></i> {{ job.location }} |
                <i class="fas fa-calendar"></i> Posted {{
                job.posted_date|date:"M d, Y" }}
              </small>
            </p>
            <p class="card-text">{{ job.description|truncatewords:50 }}</p>
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <a
                  href="{{ job.source_url }}"
                  target="_blank"
                  class="btn btn-outline-primary btn-sm"
                >
                  View on {{ job.get_source_display }}
                </a>
                {% if job.has_tailored_documents %}
                <a
                  href="{% url 'core:job_detail' job.id %}"
                  class="btn btn-outline-success btn-sm"
                >
                  View Documents
                </a>
                {% endif %}
              </div>
              <div>
                <span class="badge bg-{{ job.source }}"
                  >{{ job.get_source_display }}</span
                >
              </div>
            </div>
          </div>
        </div>
        {% endfor %} {% else %}
        <div class="alert alert-info">
          No jobs found. Try adjusting your search criteria.
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block extra_js %}
<script>
  document
    .getElementById("jobSearchForm")
    .addEventListener("submit", function (e) {
      e.preventDefault();

      const role = document.getElementById("role").value;
      const location = document.getElementById("location").value;
      const selectedPlatforms = Array.from(
        document.querySelectorAll(
          'input[type="checkbox"][name^="platform"]:checked'
        )
      ).map((checkbox) => checkbox.value);

      // Show loading spinner
      const loadingSpinner = document.getElementById("loadingSpinner");
      if (loadingSpinner) {
        loadingSpinner.classList.remove("d-none");
      }

      // Clear previous results and warnings
      const resultsDiv = document.getElementById("searchResults");
      resultsDiv.innerHTML = "";

      // Create a warning div
      const warningDiv = document.createElement("div");
      warningDiv.id = "searchWarnings";
      resultsDiv.appendChild(warningDiv);

      // Make API call
      fetch("/api/search-jobs/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({
          role: role,
          location: location,
          platforms: selectedPlatforms,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          // Hide loading spinner
          if (loadingSpinner) {
            loadingSpinner.classList.add("d-none");
          }

          // Display any warnings if present
          if (data.warnings) {
            warningDiv.innerHTML = `
              <div class="alert alert-warning alert-dismissible fade show" role="alert">
                <strong>Some issues occurred:</strong><br>
                ${data.warnings.join("<br>")}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            `;
          }

          if (data.jobs && data.jobs.length > 0) {
            // Create results container
            const jobsContainer = document.createElement("div");
            jobsContainer.className = "job-listings mt-3";

            // Add each job card
            data.jobs.forEach((job) => {
              const jobCard = createJobCard(job);
              jobsContainer.appendChild(jobCard);
            });

            resultsDiv.appendChild(jobsContainer);

            // Update URL with search parameters
            const url = new URL(window.location.href);
            url.searchParams.set("role", role);
            url.searchParams.set("location", location);
            window.history.pushState({}, "", url);
          } else {
            resultsDiv.innerHTML += `
              <div class="alert alert-info mt-3">
                No jobs found. Try adjusting your search criteria.
              </div>
            `;
          }
        })
        .catch((error) => {
          // Hide loading spinner
          if (loadingSpinner) {
            loadingSpinner.classList.add("d-none");
          }

          console.error("Error:", error);
          resultsDiv.innerHTML = `
            <div class="alert alert-danger">
              ${error.message || "An error occurred while searching for jobs."}
            </div>
          `;
        });
    });

  // Helper function to create a job card
  function createJobCard(job) {
    const card = document.createElement("div");
    card.className = "card mb-3";

    const sourceIcon = getSourceIcon(job.source);
    const matchScoreHtml = job.match_score
      ? `<span class="badge bg-success ms-2">Match: ${Math.round(
          job.match_score * 100
        )}%</span>`
      : "";

    card.innerHTML = `
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <h5 class="card-title mb-1">
            <a href="${
              job.source_url
            }" target="_blank" class="text-decoration-none">
              ${job.title}
            </a>
            ${matchScoreHtml}
          </h5>
          <span class="badge bg-secondary">
            ${sourceIcon} ${job.source}
          </span>
        </div>
        <h6 class="card-subtitle mb-2 text-muted">${job.company} - ${
      job.location
    }</h6>
        <p class="card-text">${truncateText(job.description, 200)}</p>
        <div class="d-flex justify-content-between align-items-center">
          <small class="text-muted">Posted: ${formatDate(
            job.posted_date
          )}</small>
          <div class="btn-group">
            <a href="/jobs/${
              job.id
            }/" class="btn btn-sm btn-outline-primary">View Details</a>
            ${
              !job.applied
                ? `<button onclick="applyToJob(${job.id})" class="btn btn-sm btn-success">Apply</button>`
                : '<span class="badge bg-info ms-2">Applied</span>'
            }
          </div>
        </div>
      </div>
    `;

    return card;
  }

  // Helper function to get platform icon
  function getSourceIcon(source) {
    const icons = {
      linkedin: '<i class="fab fa-linkedin"></i>',
      indeed: '<i class="fas fa-search"></i>',
      glassdoor: '<i class="fas fa-door-open"></i>',
      monster: '<i class="fas fa-dragon"></i>',
      jobbank: '<i class="fas fa-piggy-bank"></i>',
      ziprecruiter: '<i class="fas fa-file-archive"></i>',
      other: '<i class="fas fa-briefcase"></i>',
    };
    return icons[source.toLowerCase()] || icons["other"];
  }

  // Helper function to truncate text
  function truncateText(text, maxLength) {
    if (text.length <= maxLength) return text;
    return text.substr(0, maxLength) + "...";
  }

  // Helper function to format date
  function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString("en-US", {
      year: "numeric",
      month: "short",
      day: "numeric",
    });
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function getAuthToken() {
    // Implement your logic to retrieve the auth token from localStorage or cookies
    return localStorage.getItem("authToken");
  }
</script>
{% endblock %}
